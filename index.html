<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Uploader </title>
    <link rel="stylesheet" 
        href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" 
        integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" 
        crossorigin="anonymous"
    >
</head>
<body>
    <div class="container">
        <h3 class="text-center mt-4"> Uploader </h3>

        File <input type="file"  id="file">
        <button id="upload"> Add Files </button>
        <div id="output"> </div>

        <script>
            const upload = document.getElementById("upload");
            const output = document.getElementById("output");
            const file   = document.getElementById("file");

            upload.addEventListener("click", () => {
                const fileReader = new FileReader();
                const newFile = file.files[0];
                fileReader.onload = async event => {
                    const CHUNK_SIZE = 5000;
                    const chunkCount = (event.target.result.byteLength / CHUNK_SIZE);
                    console.log("Read successfully");
                    const fileName = Math.random() * 1000 + newFile.name;
                    for (let chunkId = 0; chunkId < chunkCount + 1; chunkId ++ ){
                        const chunk = event.target.result.slice(chunkId * CHUNK_SIZE, chunkId * CHUNK_SIZE + CHUNK_SIZE );
                        await fetch ("http://localhost:8100/upload", {
                            "method": "POST",
                            "headers": {
                                "content-type": "application/octet-stream",
                                "content-length": chunk.length,
                                "file-name": fileName
                            },
                            "body": chunk
                        })
                        output.textContent = Math.round(chunkId * 100/chunkCount,0) + "%"
                    }
                    console.log(event.target.result.byteLength);

                }
                fileReader.readAsArrayBuffer(newFile);
            })
        </script>
        

    </div>
</body>
</html>